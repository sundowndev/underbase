!function(e){var t={};function i(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,o){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(o,n,function(t){return e[t]}.bind(null,n));return o},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=7)}([function(e,t,i){"use strict";(function(e){var o,n=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=i(4),s=i(3);t.initMigrator=e=>n(this,void 0,void 0,function*(){return t.logger.info("Connecting to MongoDB..."),yield s.migrator.config(e),s.migrator}),t.logger={info:(...e)=>{console.log(r.default.bold("[INFO]"),...e)},warn:(...e)=>{console.log(r.default.bold("[WARNING]"),...e)},success:(...e)=>{console.log(r.default.green(`✔ ${e.join(" ")}`))},error:(...e)=>{console.log(r.default.bgRed("ERROR"),r.default.red(`${e.join(" ")}`))},log:(...e)=>{console.log(...e)}},t.timer=()=>{const e=(new Date).getTime();return{spent:()=>((new Date).getTime()-e)/1e3}},t.exit=(e=0)=>{process.exit(e)},t.importFile=t=>n(this,void 0,void 0,function*(){o=i(5)(e);try{return yield o(t).default}catch(e){throw new Error(e)}})}).call(this,i(2)(e))},function(e,t){e.exports=require("fs-extra")},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(10);t.Migration=o.Migration;const n=new o.Migration;t.migrator=n},function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("esm")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(21),n=i(0);t.create=(e,t)=>new Promise((i,r)=>{n.logger.info("Creating backup...");const s=e.db.split("/");let c,a;"mongodb:"===s[0]&&""===s[1]?(c=s[2],a=s[3]):(c=s[0],a=s[1]);const l=[t.toFixed(1),`${Date.now()}.gz`].join("_"),u=[e.mongodumpBinary,`--host ${c}`,`--archive=${e.backupsDir}/${l}`,`--gzip --db ${a}`].join(" ");o.exec(u,(t,o,r)=>(t&&(n.logger.error("An error occured while creating backup... Cancelling migration."),console.error(t),n.exit()),n.logger.info(`Backup created : ${e.backupsDir}/${l}`),i()))})},function(e,t,i){"use strict";(function(e){var o,n=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=i(1),s=i(8),c=i(9),a=i(3),l=i(0),u=i(17),d=i(18),g=i(19),h=i(20),f=i(22),p=i(23),y=i(24),m={init:d,list:g,migrate:h,status:p,unlock:y,rerun:f};o=i(5)(e);const v=c.scriptName("underbase").usage("Usage: $0 <command> [OPTIONS]").command("migrate <migration>",h.describe).command("init",d.describe).command("list",g.describe).command("status",p.describe).command("unlock",y.describe).command("rerun",f.describe).describe("config <path>","Configuration file path").describe("db <url>","MongoDB connection URL").describe("migrations-dir <path>","Migrations versions directory").describe("backup","Enable automatic backups").describe("backups-dir <path>","Backups directory").describe("collection-name <name>","Migrations state collection").describe("logs","Enable logs").describe("chdir <path>","Change the working directory").describe("version","Show package version").describe("mongodumpBinary <path>","Binary file for mongodump (it can be a docker exec command)").help("h","Show this help message").alias("h","help").locale("en_US").parse();let b={};const w=v.chdir||b.chdir||process.cwd();v.config&&(b=o(s.resolve(v.config)));const _={workingDirectory:w,logs:v.logs||b.logs||!0,logger:l.logger,logIfLatest:!0,collectionName:v.collectionName||b.collectionName||"migrations",db:v.db||b.db||null,backup:v.backup||b.backup||!1,backupsDir:s.resolve(v.backupsDir||b.backupsDir||"./migrations/backups"),migrationsDir:s.resolve(v.migrationsDir||b.migrationsDir||"./migrations"),mongodumpBinary:v.mongodumpBinary||b.mongodumpBinary||"mongodump"};!function(){n(this,void 0,void 0,function*(){u.checkNoArgPassed(c,v);const e=r.existsSync(_.migrationsDir)?r.readdirSync(_.migrationsDir).filter(e=>e.match(new RegExp(/^[\d].[\d]$/))):[];Object.keys(m).indexOf(v._[0])>-1?(u.checkMigrationDirExists(_),u.createbackupDir(_),yield m[v._[0]].action({config:_,versions:e,argv:v,migrator:a.migrator})):l.logger.error("Invalid command. Use --help option to show available commands."),l.exit()})}()}).call(this,i(2)(e))},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("yargs")},function(e,t,i){"use strict";var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=i(11),r=i(4),s=i(12),c=i(13),a=i(14),l=i(0),u=i(15),d=a.typeCheck;t.Migration=class{constructor(e){this.defaultMigration={version:0,up:()=>{}},this._list=[this.defaultMigration],this.options=e||{logs:!0,logger:null,logIfLatest:!0,collectionName:"migrations",db:null}}getConfig(){return this.options}getMigrations(){return this._list}isLocked(){return o(this,void 0,void 0,function*(){return null!==(yield this._collection.findOne({_id:"control",locked:!0}))})}config(e){return o(this,void 0,void 0,function*(){if(this.options=Object.assign({},this.options,e),!this.options.logger&&this.options.logs&&(this.options.logger=l.logger),!1===this.options.logs&&(this.options.logger=(...e)=>{}),!(this._db instanceof c.Db||this.options.db))throw new ReferenceError("Option.db canno't be null");let t;t="string"==typeof this.options.db?(yield c.MongoClient.connect(this.options.db,{promiseLibrary:n.Promise,useNewUrlParser:!0})).db():this.options.db,this._collection=t.collection(this.options.collectionName),this._db=t})}add(e){if("function"!=typeof e.up)throw new Error("Migration must supply an up function.");if("function"!=typeof e.down)throw new Error("Migration must supply a down function.");if("number"!=typeof e.version)throw new Error("Migration must supply a version number.");if(e.version<=0)throw new Error("Migration version must be greater than 0");Object.freeze(e),this._list.push(e),this._list=s.sortBy(this._list,e=>e.version)}migrateTo(e){return o(this,void 0,void 0,function*(){if(!this._db)throw new Error("Migration instance has not be configured/initialized. Call <instance>.config(..) to initialize this instance");if(s.isUndefined(e)||""===e||0===this.getMigrations().length)throw new Error("Cannot migrate using invalid command: "+e);let t,i;"number"==typeof e?t=e:(t=e.split(",")[0],i=e.split(",")[1]);try{"latest"===t?yield this.execute(s.last(this.getMigrations()).version):yield this.execute(parseFloat(t),"rerun"===i)}catch(e){throw this.options.logger.info("Encountered an error while migrating. Migration failed."),e}})}getNumberOfMigrations(){return this.getMigrations().length-1}getVersion(){return o(this,void 0,void 0,function*(){return(yield this.getControl()).version})}unlock(){return o(this,void 0,void 0,function*(){yield this._collection.updateOne({_id:"control"},{$set:{locked:!1}})})}reset(){return o(this,void 0,void 0,function*(){this._list=[this.defaultMigration],yield this._collection.deleteMany({})})}execute(e,t){return o(this,void 0,void 0,function*(){const i=this;let n=(yield this.getControl()).version;const s=(e,t)=>o(this,void 0,void 0,function*(){const n=i.getMigrations()[t];if("function"!=typeof n[e])throw yield c(),new Error("Cannot migrate "+e+" on version "+n.version);this.options.logger.log("\n",r.default.yellow("Running "+e+"() on version "+n.version)),n.describe&&this.options.logger.log(" ".repeat(4),r.default.grey(n.describe)),"AsyncFunction"!==n[e].constructor.name&&"Promise"!==n[e].constructor.name&&this.options.logger.log(" ".repeat(4),r.default.bold("[WARNING]"),r.default.yellow(`One of the ${e} functions is nor Async or Promise (${n.describe||"not described"})`));const s={MongoClient:this._db,Migrate:t=>o(this,void 0,void 0,function*(){for(const i in t)if(t.hasOwnProperty(i)){"AsyncFunction"!==t[i][e].constructor.name&&"Promise"!==t[i][e].constructor.name&&this.options.logger.warn(`One of the ${e} functions is nor Async or Promise`,`(${t[i].describe||"not described"})`),t[i].describe&&this.options.logger.log(" ".repeat(8),r.default.grey(t[i].describe));try{yield t[i][e](s)}catch(e){throw new Error(e)}}}),Query:new u.QueryInterface(i._db),Logger:(...e)=>this.options.logger.log(" ".repeat(8),r.default.inverse("LOGGER"),...e)};try{yield n[e](s),this.options.logger.log("")}catch(e){throw new Error(e)}}),c=()=>i.setControl({locked:!1,version:n}),a=()=>o(this,void 0,void 0,function*(){return yield i.setControl({locked:!0,version:n})});if(!1===(yield(()=>o(this,void 0,void 0,function*(){const e=yield i._collection.findOneAndUpdate({_id:"control",locked:!1},{$set:{locked:!0,lockedAt:new Date}});return null!=e.value&&1===e.ok}))()))return void this.options.logger.info("Not migrating, control is locked.");if(t)return this.options.logger.info("Rerunning version "+e),yield s("up",this.findIndexByVersion(e)),this.options.logger.success("Finished migrating"),void(yield c());if(n===e)return this.options.logIfLatest&&this.options.logger.error("Not migrating, already at version "+e),void(yield c());const l=this.findIndexByVersion(n),d=this.findIndexByVersion(e);if(this.options.logger.info("Migrating from version "+this.getMigrations()[l].version+" -> "+this.getMigrations()[d].version),n<e)for(let t=l;t<d;t++)try{yield s("up",t+1),n=i.getMigrations()[t+1].version,yield a()}catch(t){throw this.options.logger.error(`Encountered an error while migrating from ${n} to ${e}`),t}else for(let t=l;t>d;t--)try{yield s("down",t),n=i.getMigrations()[t-1].version,yield a()}catch(t){throw this.options.logger.error(`Encountered an error while migrating from ${n} to ${e}`),t}yield c(),this.options.logger.success("Finished migrating.")})}getControl(){return o(this,void 0,void 0,function*(){return(yield this._collection.findOne({_id:"control"}))||(yield this.setControl({version:0,locked:!1}))})}setControl(e){return o(this,void 0,void 0,function*(){d("Number",e.version),d("Boolean",e.locked);const t=yield this._collection.updateOne({_id:"control"},{$set:{version:e.version,locked:e.locked}},{upsert:!0});return t&&t.result.ok?e:null})}findIndexByVersion(e){for(let t=0;t<this.getMigrations().length;t++)if(this.getMigrations()[t].version===e)return t;throw new Error("Can't find migration version "+e)}}},function(e,t){e.exports=require("bluebird")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("mongodb")},function(e,t){e.exports=require("type-check")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(16);t.QueryInterface=class{constructor(e){this.collection=e=>(this._collection=this._db.collection(e),new o.MongoCollection(e,this._collection,this._db)),this._db=e}}},function(e,t,i){"use strict";var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});t.MongoCollection=class{constructor(e,t,i){this.rename=(e,t)=>{const i={};return i[e]=t,this._updateQuery={$rename:i},{where:this.where}},this.unset=e=>{const t={};if("string"==typeof e)t[e]=1;else{if(!Array.isArray(e))throw new Error("Field name in .unset() must of type string or array.");for(const i of e)t[i]=1}return this._updateQuery={$unset:t},{where:this.where}},this.set=(e,t)=>{const i={};return i[e]=t,this._updateQuery={$set:i||{}},{where:this.where}},this.drop=()=>o(this,void 0,void 0,function*(){return yield this._db.dropCollection(this._collectionName)}),this.count=(e={})=>o(this,void 0,void 0,function*(){return this._whereQuery=e,yield this._collection.find(this._whereQuery,{}).count()}),this.where=(e={})=>o(this,void 0,void 0,function*(){return this._whereQuery=e,yield this.execute()}),this.reset=()=>{this._updateQuery={},this._whereQuery={},this.cursorOptions={cursor:{batchSize:500},allowDiskUse:!0}},this.execute=()=>o(this,void 0,void 0,function*(){return yield this.cursor(this._whereQuery,e=>{this._collection.updateOne({_id:e._id},this._updateQuery)})}),this.cursor=(e,t)=>o(this,void 0,void 0,function*(){return new Promise((i,n)=>o(this,void 0,void 0,function*(){const o=yield this._collection.aggregate([{$match:e||{}}],this.cursorOptions,null);o.on("data",e=>t(e)),o.on("close",()=>n("MongoDB closed the connection")),o.on("end",()=>i())}))}),this._db=i,this._collectionName=e,this._collection=t,this._updateQuery={},this._whereQuery={},this.cursorOptions={cursor:{batchSize:500},allowDiskUse:!0}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(1),n=i(0);t.checkNoArgPassed=(e,t)=>{t._[0]||(e.showHelp(),n.exit())},t.checkMigrationDirExists=e=>{o.existsSync(e.migrationsDir)||n.logger.warn("Migration directory does not exists. Please run underbase init.")},t.createbackupDir=e=>{!o.existsSync(e.backupsDir)&&e.backup&&(o.mkdirpSync(e.backupsDir),n.logger.info("Created backup directory."))}},function(e,t,i){"use strict";var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=i(1),r=i(0);t.describe="Initiate migration environment",t.action=({config:e})=>o(this,void 0,void 0,function*(){n.existsSync(e.migrationsDir)?r.logger.info("Migration directory already exists."):(yield n.mkdirpSync(e.migrationsDir),r.logger.info("Created migration directory.")),!n.existsSync(e.backupsDir)&&e.backup&&(yield n.mkdirpSync(e.backupsDir),r.logger.info("Created backup directory."))})},function(e,t,i){"use strict";var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=i(1),r=i(0);t.describe="Show available migrations versions",t.action=({config:e,versions:t})=>o(this,void 0,void 0,function*(){n.existsSync(e.migrationsDir)&&(r.logger.info("Versions list based on folders"),t.forEach(e=>r.logger.log(`- ${e}`)))})},function(e,t,i){"use strict";var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=i(6),r=i(0);t.describe="Migrate to a specified version",t.action=({config:e,versions:t,argv:i})=>o(this,void 0,void 0,function*(){const o=t.map(e=>parseFloat(e));if(0!==i.migration&&"latest"!==i.migration&&o.indexOf(parseFloat(i.migration))<0)return r.logger.error("This version does not exists."),r.exit();(t=o.map(e=>e.toFixed(1))).sort((e,t)=>e-t);const s=yield r.initMigrator(e);for(const i in t)if(t.hasOwnProperty(i)){const o=yield r.importFile(`${e.migrationsDir}/${t[i]}`);yield s.add(o)}if(e.backup){const t=yield s.getVersion();yield n.create(e,t)}const c=r.timer();yield s.migrateTo(i.migration),r.logger.log(""),r.logger.log("⌛",`Time spent: ${c.spent()} sec`)})},function(e,t){e.exports=require("child_process")},function(e,t,i){"use strict";var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=i(6),r=i(0);t.describe="Rerun the current version",t.action=({config:e,versions:t})=>o(this,void 0,void 0,function*(){const i=t.map(e=>parseFloat(e));(t=i.map(e=>e.toFixed(1))).sort((e,t)=>e-t);const o=yield r.initMigrator(e);for(const i in t)if(t.hasOwnProperty(i)){const n=yield r.importFile(`${e.migrationsDir}/${t[i]}`);yield o.add(n)}const s=yield o.getVersion();e.backup&&(yield n.create(e,s));const c=r.timer();yield o.migrateTo(`${s},rerun`),r.logger.log(""),r.logger.log("⌛",`Time spent: ${c.spent()} sec`)})},function(e,t,i){"use strict";var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);t.describe="Show migrations status",t.action=({config:e})=>o(this,void 0,void 0,function*(){const t=yield n.initMigrator(e),i=yield t.getVersion(),o=(yield t.isLocked())?"locked":"not locked";n.logger.info(`Current version is ${i}`),n.logger.info(`Migration state is ${o}`)})},function(e,t,i){"use strict";var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);t.describe="Unlock migrations state",t.action=({config:e})=>o(this,void 0,void 0,function*(){const t=yield n.initMigrator(e);if(yield t.isLocked()){const e=n.timer();yield t.unlock(),n.logger.info("Migration state unlocked."),n.logger.info(`Time spent: ${e.spent()} sec`)}else n.logger.info("Migration state is already unlocked.")})}]);